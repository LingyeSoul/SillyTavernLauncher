name: Build Windows Flet App

on:
  push:
    branches:
      - main
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      APP_NAME: SillyTavernLauncher
      PRODUCT_NAME: "é…’é¦†å¯åŠ¨å™¨"
      COMPANY_NAME: LingyeSoul
      ICON_PATH: src/assets/icon.ico
      DIST_PATH: dist
      COPYRIGHT: "Copyright (c) 2025 LingyeSoul"

    steps:
      - name: ğŸ” æ‹‰å–ä¸»é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ æ¸…ç†å·¥ä½œåŒº
        run: |
          if (Test-Path $env:DIST_PATH) { Remove-Item -Recurse -Force $env:DIST_PATH }
          if (Test-Path *.zip) { Remove-Item -Force *.zip }
        shell: pwsh

      - name: â³ ç¼“å­˜ GitVersion
        uses: actions/cache@v4
        with:
          path: C:\GitVersion
          key: gitversion-5.x
          restore-keys: gitversion-

      - name: ğŸ› ï¸ å®‰è£… GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.13
        with:
          versionSpec: '5.x'

      - name: ğŸ“Š è·å–ç‰ˆæœ¬å·
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.13

      - name: ğŸ§¾ æå–ç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "SEMVER=${{ steps.gitversion.outputs.SemVer }}" >> $GITHUB_ENV
          echo "MAJOR=${{ steps.gitversion.outputs.Major }}" >> $GITHUB_ENV
          echo "MINOR=${{ steps.gitversion.outputs.Minor }}" >> $GITHUB_ENV
          echo "PATCH=${{ steps.gitversion.outputs.Patch }}" >> $GITHUB_ENV
        shell: bash

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ å‡çº§ pip å’Œå®‰è£…åŸºç¡€ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install flet pyinstaller ruamel.yaml packaging Nuitka

      - name: ğŸ”§ å®‰è£…è‡ªå®šä¹‰ flet-cli
        run: |
          # å¸è½½é»˜è®¤çš„ flet-cliï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          pip uninstall -y flet-cli
          
          # å®‰è£…è‡ªå®šä¹‰ç‰ˆæœ¬çš„ flet-cli
          pip install git+https://github.com/LingyeSoul/flet_cli.git@main
          
          # éªŒè¯å®‰è£…ç‰ˆæœ¬
          echo "=== å·²å®‰è£…çš„ flet-cli ä¿¡æ¯ ==="
          pip show flet-cli
          
          # éªŒè¯ flet å‘½ä»¤æ˜¯å¦å¯ç”¨
          flet --version
          flet pack --help
        shell: pwsh

      - name: ğŸ§± æ‰“åŒ…åº”ç”¨
        run: |
          flet packn src/main.py `
            --icon "$env:ICON_PATH" `
            --name "$env:APP_NAME" `
            --product-name "$env:PRODUCT_NAME" `
            --file-description "$env:APP_NAME $env:PRODUCT_NAME" `
            --product-version "$env:SEMVER" `
            --copyright "$env:COPYRIGHT" `
            --distpath "$env:DIST_PATH" `
            --yes
        shell: pwsh

      - name: ğŸ—‚ï¸ å‹ç¼© dist åˆ° ZIP
        id: compress_dist
        run: |
          $zipName = "$env:APP_NAME-win-v${{ env.SEMVER }}.zip"
          Compress-Archive -Path "$env:DIST_PATH\*" -DestinationPath $zipName -Force
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: âœ… éªŒè¯ ZIP æ–‡ä»¶
        run: |
          $path = "${{ steps.compress_dist.outputs.zip_name }}"
          if (-Not (Test-Path $path)) {
              throw "âŒ ZIP æ–‡ä»¶æœªç”Ÿæˆ: $path"
          }
          $size = (Get-Item $path).Length / 1MB
          Write-Host "âœ… ZIP æ–‡ä»¶å­˜åœ¨: $path (å¤§å°: $([math]::Round($size, 2)) MB)"
        shell: pwsh

      - name: â±ï¸ è·å–å½“å‰æ—¶é—´ï¼ˆä¸Šæµ·æ—¶åŒºï¼Œä¸­æ–‡æ ¼å¼ï¼‰
        id: timestamp
        run: |
          $tz = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
          $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $tz)
          $formatted = $now.ToString("yyyyå¹´MMæœˆddæ—¥ HHæ—¶mmåˆ†ssç§’")
          "now=$formatted" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: ğŸ“œ ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆæœ€è¿‘ 5 æ¡ commitï¼‰
        id: changelog
        run: |
          $log = git log --pretty=format:"* [%h] %s (%an)" -n 5
          Add-Content -Path $env:GITHUB_OUTPUT -Value "log<<EOF"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "$log"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"
        shell: pwsh

      - name: ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼  ZIPï¼ˆä»…åœ¨ release è§¦å‘æ—¶ï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.compress_dist.outputs.zip_name }}
          tag_name: v${{ env.SEMVER }}
          name: Release v${{ env.SEMVER }}
          body: |
            # ğŸš€ ${{ env.PRODUCT_NAME }} v${{ env.SEMVER }} å‘å¸ƒï¼

            ## ğŸ› ï¸ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.log }}

            ## ğŸ“¦ æ„å»ºä¿¡æ¯

            - æ‰“åŒ…æ—¶é—´ï¼š${{ steps.timestamp.outputs.now }}
            - ç‰ˆæœ¬å·ï¼šv${{ env.SEMVER }}
            - æ„å»ºç³»ç»Ÿï¼šWindows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ ä¸Šä¼  Artifactï¼ˆä¾›è°ƒè¯•æˆ–ä¸‹è½½ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-v${{ env.SEMVER }}
          path: ${{ steps.compress_dist.outputs.zip_name }}
          if-no-files-found: error
