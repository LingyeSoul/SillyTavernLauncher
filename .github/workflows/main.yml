name: Build Windows Flet App

on:
  push:
    branches:
      - main
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      APP_NAME: SillyTavernLauncher
      PRODUCT_NAME: "é…’é¦†å¯åŠ¨å™¨"
      COMPANY_NAME: LingyeSoul
      ICON_PATH: src/assets/icon.ico
      DIST_PATH: dist
      COPYRIGHT: "Copyright (c) 2025 LingyeSoul"

    steps:
      - name: ğŸ” æ‹‰å–ä¸»é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§¹ æ¸…ç†å·¥ä½œåŒº
        run: |
          if (Test-Path $env:DIST_PATH) { Remove-Item -Recurse -Force $env:DIST_PATH }
          if (Test-Path *.zip) { Remove-Item -Force *.zip }
        shell: pwsh

      - name: â³ ç¼“å­˜ GitVersion
        uses: actions/cache@v4
        with:
          path: C:\GitVersion
          key: gitversion-5.x
          restore-keys: gitversion-

      - name: ğŸ› ï¸ å®‰è£… GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.13
        with:
          versionSpec: '5.x'

      - name: ğŸ“Š è·å–ç‰ˆæœ¬å·
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.13

      - name: ğŸ§¾ æå–ç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "SEMVER=${{ steps.gitversion.outputs.SemVer }}" >> $GITHUB_ENV
          echo "MAJOR=${{ steps.gitversion.outputs.Major }}" >> $GITHUB_ENV
          echo "MINOR=${{ steps.gitversion.outputs.Minor }}" >> $GITHUB_ENV
          echo "PATCH=${{ steps.gitversion.outputs.Patch }}" >> $GITHUB_ENV
        shell: bash

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install flet pyinstaller ruamel.yaml packaging Nuitka flet-cli==0.28.3

      # âœ… æ–°å¢ï¼šæ£€å‡ºä½ è‡ªå·±çš„ flet_cli ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºè‡ªå®šä¹‰ flet_cli ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: LingyeSoul/flet_cli
          path: ./custom_flet_cli
          ref: main  # æˆ–æŒ‡å®š tag/branchï¼Œå¦‚ v1.0

      # âœ… æ›¿æ¢ flet_cli çš„æ–‡ä»¶
      - name: ğŸ”§ æ³¨å…¥è‡ªå®šä¹‰ flet_cliï¼ˆä»ä»“åº“ï¼‰
        run: |
          # è·å–å·²å®‰è£…çš„ flet_cli è·¯å¾„
          $installed_path = python -c "import flet_cli; print(flet_cli.__file__.replace('__init__.py', ''))"
          Write-Host "å·²å®‰è£…çš„ flet_cli è·¯å¾„: $installed_path"

          # æ›¿æ¢ cli.py
          Copy-Item -Path "./custom_flet_cli/cli.py" -Destination "$installed_path\cli.py" -Force

          # ç¡®ä¿ commands ç›®å½•å­˜åœ¨
          $commands_dir = "$installed_path\commands"
          if (!(Test-Path $commands_dir)) {
            New-Item -ItemType Directory -Path $commands_dir
          }

          # å¤åˆ¶ packn.py
          Copy-Item -Path "./custom_flet_cli/packn.py" -Destination "$commands_dir\packn.py" -Force

          Write-Host "âœ… å·²ä» ./custom_flet_cli æ³¨å…¥ cli.py å’Œ packn.py"
        shell: pwsh

      # âœ… ä½¿ç”¨ä½ æŒ‡å®šçš„ packn å‘½ä»¤æ‰“åŒ…
      - name: ğŸ§± æ‰“åŒ…åº”ç”¨ï¼ˆä½¿ç”¨ packnï¼‰
        run: |
          flet packn src/main.py `
            --icon "$env:ICON_PATH" `
            --name "$env:APP_NAME" `
            --product-name "$env:PRODUCT_NAME" `
            --file-description "$env:APP_NAME $env:PRODUCT_NAME" `
            --product-version "$env:SEMVER" `
            --copyright "$env:COPYRIGHT" `
            --distpath "$env:DIST_PATH" `
            --yes
        shell: pwsh

      - name: ğŸ—‚ï¸ å‹ç¼© dist åˆ° ZIP
        id: compress_dist
        run: |
          $zipName = "$env:APP_NAME-win-v${{ env.SEMVER }}.zip"
          Compress-Archive -Path "$env:DIST_PATH\*" -DestinationPath $zipName -Force
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: âœ… éªŒè¯ ZIP æ–‡ä»¶
        run: |
          $path = "${{ steps.compress_dist.outputs.zip_name }}"
          if (-Not (Test-Path $path)) {
              throw "âŒ ZIP æ–‡ä»¶æœªç”Ÿæˆ: $path"
          }
          Write-Host "âœ… ZIP æ–‡ä»¶å­˜åœ¨: $path"
        shell: pwsh

      - name: â±ï¸ è·å–å½“å‰æ—¶é—´ï¼ˆä¸Šæµ·æ—¶åŒºï¼Œä¸­æ–‡æ ¼å¼ï¼‰
        id: timestamp
        run: |
          $tz = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
          $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $tz)
          $formatted = $now.ToString("yyyyå¹´MMæœˆddæ—¥ HHæ—¶mmåˆ†ssç§’")
          "now=$formatted" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: ğŸ“œ ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆæœ€è¿‘ 5 æ¡ commitï¼‰
        id: changelog
        run: |
          $log = git log --pretty=format:"* [%h] %s (%an)" -n 5
          Add-Content -Path $env:GITHUB_OUTPUT -Value "log<<EOF"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "$log"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"
        shell: pwsh

      - name: ğŸš€ åˆ›å»º Release å¹¶ä¸Šä¼  ZIPï¼ˆä»…åœ¨ release è§¦å‘æ—¶ï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.compress_dist.outputs.zip_name }}
          tag_name: v${{ env.SEMVER }}
          name: Release v${{ env.SEMVER }}
          body: |
            # ğŸš€ ${{ env.PRODUCT_NAME }} v${{ env.SEMVER }} å‘å¸ƒï¼

            ## ğŸ› ï¸ æ›´æ–°å†…å®¹

            ${{ steps.changelog.outputs.log }}

            ## ğŸ“¦ æ„å»ºä¿¡æ¯

            - æ‰“åŒ…æ—¶é—´ï¼š${{ steps.timestamp.outputs.now }}
            - ç‰ˆæœ¬å·ï¼šv${{ env.SEMVER }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ ä¸Šä¼  Artifactï¼ˆä¾›è°ƒè¯•æˆ–ä¸‹è½½ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-v${{ env.SEMVER }}
          path: ${{ steps.compress_dist.outputs.zip_name }}
          if-no-files-found: error
