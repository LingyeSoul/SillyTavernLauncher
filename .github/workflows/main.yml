name: Build Windows Flet App

on:
  push:
    branches:
      - main
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      APP_NAME: SillyTavernLauncher
      PRODUCT_NAME: "酒馆启动器"
      COMPANY_NAME: LingyeSoul
      ICON_PATH: src/assets/icon.ico
      DIST_PATH: dist
      COPYRIGHT: "Copyright (c) 2025 LingyeSoul"

    steps:
      - name: 🔁 拉取主项目代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🧹 清理工作区
        run: |
          if (Test-Path $env:DIST_PATH) { Remove-Item -Recurse -Force $env:DIST_PATH }
          if (Test-Path *.zip) { Remove-Item -Force *.zip }
        shell: pwsh

      - name: ⏳ 缓存 GitVersion
        uses: actions/cache@v4
        with:
          path: C:\GitVersion
          key: gitversion-5.x
          restore-keys: gitversion-

      - name: 🛠️ 安装 GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.13
        with:
          versionSpec: '5.x'

      - name: 📊 获取版本号
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.9.13

      - name: 🧾 提取版本信息
        run: |
          echo "SEMVER=${{ steps.gitversion.outputs.SemVer }}" >> $GITHUB_ENV
          echo "MAJOR=${{ steps.gitversion.outputs.Major }}" >> $GITHUB_ENV
          echo "MINOR=${{ steps.gitversion.outputs.Minor }}" >> $GITHUB_ENV
          echo "PATCH=${{ steps.gitversion.outputs.Patch }}" >> $GITHUB_ENV
        shell: bash

      - name: 🐍 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📦 升级 pip 和安装基础依赖
        run: |
          python -m pip install --upgrade pip
          pip install flet pyinstaller ruamel.yaml packaging Nuitka

      - name: 🔧 安装自定义 flet-cli
        run: |
          # 卸载默认的 flet-cli（如果存在）
          pip uninstall -y flet-cli
          
          # 安装自定义版本的 flet-cli
          pip install git+https://github.com/LingyeSoul/flet_cli.git@main
          
          # 验证安装版本
          echo "=== 已安装的 flet-cli 信息 ==="
          pip show flet-cli
          
          # 验证 flet 命令是否可用
          flet --version
          flet pack --help
        shell: pwsh

      - name: 🧱 打包应用
        run: |
          flet packn src/main.py `
            --icon "$env:ICON_PATH" `
            --name "$env:APP_NAME" `
            --product-name "$env:PRODUCT_NAME" `
            --file-description "$env:APP_NAME $env:PRODUCT_NAME" `
            --product-version "$env:SEMVER" `
            --copyright "$env:COPYRIGHT" `
            --distpath "$env:DIST_PATH" `
            --yes
        shell: pwsh

      - name: 🗂️ 压缩 dist 到 ZIP
        id: compress_dist
        run: |
          $zipName = "$env:APP_NAME-win-v${{ env.SEMVER }}.zip"
          Compress-Archive -Path "$env:DIST_PATH\*" -DestinationPath $zipName -Force
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: ✅ 验证 ZIP 文件
        run: |
          $path = "${{ steps.compress_dist.outputs.zip_name }}"
          if (-Not (Test-Path $path)) {
              throw "❌ ZIP 文件未生成: $path"
          }
          $size = (Get-Item $path).Length / 1MB
          Write-Host "✅ ZIP 文件存在: $path (大小: $([math]::Round($size, 2)) MB)"
        shell: pwsh

      - name: ⏱️ 获取当前时间（上海时区，中文格式）
        id: timestamp
        run: |
          $tz = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
          $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $tz)
          $formatted = $now.ToString("yyyy年MM月dd日 HH时mm分ss秒")
          "now=$formatted" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: 📜 生成更新日志（最近 5 条 commit）
        id: changelog
        run: |
          $log = git log --pretty=format:"* [%h] %s (%an)" -n 5
          Add-Content -Path $env:GITHUB_OUTPUT -Value "log<<EOF"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "$log"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "EOF"
        shell: pwsh

      - name: 🚀 创建 Release 并上传 ZIP（仅在 release 触发时）
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.compress_dist.outputs.zip_name }}
          tag_name: v${{ env.SEMVER }}
          name: Release v${{ env.SEMVER }}
          body: |
            # 🚀 ${{ env.PRODUCT_NAME }} v${{ env.SEMVER }} 发布！

            ## 🛠️ 更新内容

            ${{ steps.changelog.outputs.log }}

            ## 📦 构建信息

            - 打包时间：${{ steps.timestamp.outputs.now }}
            - 版本号：v${{ env.SEMVER }}
            - 构建系统：Windows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📁 上传 Artifact（供调试或下载）
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-v${{ env.SEMVER }}
          path: ${{ steps.compress_dist.outputs.zip_name }}
          if-no-files-found: error
